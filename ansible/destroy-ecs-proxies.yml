- name: build-ecr-images
  hosts: 127.0.0.1
  connection: local
  gather_facts: yes

  vars:
    SERVICE_NAME: "{{ lookup('env','SERVICE_NAME') }}"
    APIGEE_ENVIRONMENT: "{{ lookup('env','APIGEE_ENVIRONMENT') }}"
    _NAMESPACE: "{{ lookup('env','_NAMESPACE') }}"
    account:  "{{ lookup('env','account') }}"
    aws_profile: "deploy-{{ APIGEE_ENVIRONMENT | lower }}-{{ SERVICE_NAME | lower }}{{ '-' + _NAMESPACE if _NAMESPACE else '' }}"


  pre_tasks:

    - name: check account
      fail:
        msg: "account not set"
      when: not account

    - name: check SERVICE_NAME
      fail:
        msg: "SERVICE_NAME not set"
      when: not SERVICE_NAME

    - name: check APIGEE_ENVIRONMENT
      fail:
        msg: "APIGEE_ENVIRONMENT not set"
      when: not APIGEE_ENVIRONMENT


  roles:
    - setup-facts
    - destroy-ecs-proxies