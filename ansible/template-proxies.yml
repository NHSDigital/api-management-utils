- name: template proxies
  hosts: 127.0.0.1
  connection: local
  gather_facts: no

  environment:
    AWS_DEFAULT_REGION: eu-west-2

  vars:
    PROXIES_DIR: "{{ lookup('env','PROXIES_DIR') }}"
    SERVICE_BASE_PATH: "{{ lookup('env','SERVICE_BASE_PATH') }}"
    service_id: "{{ lookup('env','service_id') }}"
    APIGEE_ENVIRONMENT: "{{ lookup('env', 'APIGEE_ENVIRONMENT') }}"
    APIGEE_HOSTNAME: "{{ '' if APIGEE_ENVIRONMENT == 'prod' else APIGEE_ENVIRONMENT + '.' }}api.service.nhs.uk"
    APIM_BASENAME: "{{ APIGEE_ENVIRONMENT }}.apis{{ '' if APIGEE_ENVIRONMENT == 'prod' else '.ptl' }}.apim.uk"
    pr_number: "{{ lookup('env','pr_number') }}"
    APIM_PROXY_HOSTNAME: "{{ service_id }}{{ '-' + pr_number if pr_number else '' }}.{{ APIM_BASENAME }}"
    DEPLOYED_VERSION: "{{ lookup('env', 'DEPLOYED_VERSION') }}"
    RELEASE_RELEASEID: "{{ lookup('env', 'RELEASE_RELEASEID') }}"
    SOURCE_COMMIT_ID: "{{ lookup('env', 'SOURCE_COMMIT_ID') }}"

  tasks:
    - name: stat proxies dir
      stat:
        path: "{{ PROXIES_DIR }}"
      register: st

    - name: check dir exists
      fail:
        msg: "{{ PROXIES_DIR }} does not exist"
      when: not st.stat.exists

    - name: create temporary directory
      tempfile:
        state: directory
        suffix: proxies
      register: temp_dir

    - name: template proxies
      block:
        - name: move proxies to temp location
          shell: "mv {{ PROXIES_DIR }}/* {{ temp_dir.path }}"

        - name: create target directories
          file:
            path: "{{ PROXIES_DIR }}/{{ item.path }}"
            state: directory
            mode: '{{ item.mode }}'
          with_filetree: "{{ temp_dir.path }}"
          when: item.state == 'directory'

        - name: template proxies files
          template:
            src: '{{ item.src }}'
            dest: "{{ PROXIES_DIR }}/{{ item.path }}"
            mode: '{{ item.mode }}'
          with_filetree: "{{ temp_dir.path }}"
          when: item.state == 'file'

      always:
        - name: remove temp dir
          file:
            path: "{{ temp_dir.path }}"
            state: absent
