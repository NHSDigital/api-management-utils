parameters:
  - name: service_name
    type: string
  - name: apigee_environment
  - name: apigee_organization
  - name: fully_qualified_service_name
    type: string
  - name: api_product
    type: string
    default: ''
  - name: callback_url
    type: string
    default: ''
  - name: attributes
    type: object
    default: []
  - name: steps
    type: stepList
    default: []

steps:
  - bash: |
      if [ -z "${{ parameters.callback_url }}" ]; then
        export CALLBACK_URL="https://nhsd-apim-testing-${{ parameters.apigee_environment }}.herokuapp.com/callback"
      else
        export CALLBACK_URL="${{ parameters.callback_url }}"
      fi

      echo "##vso[task.setvariable variable=CALLBACK_URL]$CALLBACK_URL"
    displayName: Set test app details

  - bash: |
      set -euo pipefail

      export SERVICE_NAME="${{ parameters.fully_qualified_service_name }}"
      export APIGEE_ENVIRONMENT="${{ parameters.apigee_environment }}"
      export APIGEE_ORGANIZATION="nhsd-${{ parameters.apigee_organization }}"
      export APIGEE_ACCESS_TOKEN="$(secret.AccessToken)"
      export API_PRODUCT="${{ parameters.api_product }}"
      export VAR_PATH="$(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/utils"

      poetry run ansible-playbook ansible/deploy-apigee-app.yml
    workingDirectory: "$(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/utils"
    displayName: "Deploy test app for functional testing"

  - template: ../components/set-app-attributes.yml
    parameters:
      test_app_attributes: ${{ parameters.attributes }}

  - template: ../components/set-app-credentials.yml
    parameters:
      service_name: ${{ parameters.service_name }}

  - ${{ each step in parameters.steps }}:
    - ${{ step }}

# TODO: Add removal of test app