parameters:
  - name: api_product
    type: string
    default: ''
  - name: callback_url
    type: string
    default: ''
  - name: attributes
    type: object
    default: []
  - name: steps
    type: stepList
    default: []

steps:
  - bash: |
      if [ -z "${{ parameters.callback_url }}" ]; then
        export CALLBACK_URL="https://nhsd-apim-testing-${{ parameters.apigee_environment }}.herokuapp.com/callback"
      else
        export CALLBACK_URL="${{ parameters.callback_url }}"
      fi

      if [ -z "${{ parameters.api_product }}" ]; then
        export API_PRODUCT="internal-testing-$(ENVIRONMENT)"
      else
        export API_PRODUCT="${{ parameters.api_product }}"
      fi

      echo "##vso[task.setvariable variable=API_PRODUCT]$API_PRODUCT"
      echo "##vso[task.setvariable variable=CALLBACK_URL]$CALLBACK_URL"
    displayName: Set test app details

  - bash: |
      set -euo pipefail

      export SERVICE_NAME="$(FULLY_QUALIFIED_SERVICE_NAME)"
      export APIGEE_ENVIRONMENT="$(ENVIRONMENT)"
      export APIGEE_ORGANIZATION="nhsd-$(APIGEE_ORGANIZATION)"
      export APIGEE_ACCESS_TOKEN="$(secret.AccessToken)"
      export API_PRODUCT="$(API_PRODUCT)"
      export CALLBACK_URL=$(CALLBACK_URL)
      export VAR_PATH="$(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/utils"

      poetry run ansible-playbook ansible/deploy-apigee-app.yml
    workingDirectory: "$(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/utils"
    displayName: "Deploy test app for functional testing"

  - template: ../components/set-app-attributes.yml
    parameters:
      test_app_attributes: ${{ parameters.attributes }}

  - template: ../components/set-app-credentials.yml
    parameters:
      service_name: $(SERVICE_NAME)

  - ${{ each step in parameters.steps }}:
    - ${{ step }}
