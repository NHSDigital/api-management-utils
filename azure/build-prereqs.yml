parameters:
  - name: 'utils_dir'
    type: string
    default: 'utils'

steps:
  # - bash: |
  #     echo "Setting python tool cache path"
  #     echo "##vso[task.setvariable variable=LD_LIBRARY_PATH;]:/agent/_work/_tool/Python/3.13.7/x64/lib/"
  #   displayName: 'Set python tool cache path'
  - bash: |
      PATCH=$(curl -s https://api.github.com/repos/actions/python-versions/releases \
        | jq -r '[.[] | .tag_name | select(startswith("3.13"))] | .[]' \
        | sort -V | tail -n 1 | cut -d- -f1)

      echo "##vso[task.setvariable variable=PY_VER]$PATCH"
      echo "Resolved latest python version: $PATCH"
      echo "##vso[task.setvariable variable=LD_LIBRARY_PATH;]/agent/_work/_tool/Python/${PATCH}/x64/lib/"
    displayName: 'Query and set python tool cache path'  


  - task: UsePythonVersion@0
    name: UsePy
    displayName: 'Use Python $(PY_VER)'
    inputs:
      versionSpec: '$(PY_VER)'

  - bash: |
      echo "Checking the python version in use to set LD_LIBRARY_PATH"
      echo "Python location: $(UsePy.pythonLocation)"
      echo "##vso[task.setvariable variable=LD_LIBRARY_PATH]$(UsePy.pythonLocation)/lib"
    displayName: 'Set LD_LIBRARY_PATH'
  

  - bash: |
      tfenv use 0.14.6
    displayName: setup terraform

  - bash: |
      if ! hash pip3 2>/dev/null; then
        sudo apt-get -yq install python3-pip
      fi
      pip3 install --upgrade pip setuptools virtualenv
      if ! hash poetry 2>/dev/null; then
        pip3 install poetry
      fi
      cd ${{ parameters.utils_dir }}
      make install
    displayName: "Install Utils dependencies"
