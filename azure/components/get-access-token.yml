parameters:
  - name: apigee_username
    type: string
  - name: apigee_password
    type: string
  - name: apigee_organization
    type: string
    
steps:
  - ${{ if eq(parameters.apigee_organization, "nhsd-prod")  }}:
    - bash: |
        curl -X POST https://nhs-digital-prod.login.apigee.com/oauth/token \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -H "Accept: application/json;charset=utf-8" \
          -H "Authorization: Basic ZWRnZWNsaTplZGdlY2xpc2VjcmV0" \
          -d "username=${{ parameters.apigee_username }}&password=${{ parameters.apigee_password }}&grant_type=password" | jq .access_token > .token

        # Set token into variable
        echo "##vso[task.setvariable variable=secret.AccessToken;issecret=true]`cat .token`"
      displayName: 'Get Apigee Access Token'

  - ${{ if eq(parameters.apigee_organization, "nhsd-nonprod")  }}:
    - bash: |
        curl -X POST https://login.apigee.com/oauth/token \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -H "Accept: application/json;charset=utf-8" \
          -H "Authorization: Basic ZWRnZWNsaTplZGdlY2xpc2VjcmV0" \
          -d "username=${{ parameters.apigee_username }}&password=${{ parameters.apigee_password }}&mfa_token=$(secret.MFACode)&grant_type=password" | jq .access_token > .token

        # Set token into variable
        echo "##vso[task.setvariable variable=secret.AccessToken;issecret=true]`cat .token`"
      displayName: 'Get Apigee Access Token'
