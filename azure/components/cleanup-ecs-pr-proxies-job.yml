parameters:
  - name: retry
    type: string

steps:
      - template: ./aws-assume-role.yml
        parameters:
          role: "auto-ops"
          profile: "apm_ptl"
      
      - bash: |
          echo ${{ parameters.retry }}
          if ${{ parameters.retry }} != "2"; then
            echo "Re-assuming role and re-running step"
            echo "##vso[task.setvariable variable=has_aws_role_timedout;]true"
          fi
        displayName: "Test retry logic"


      # - bash: |
      #     export retain_hours=72
      #     sleep 90
      #     ANSIBLE_FORCE_COLOR=yes make -C ansible remove-old-ecs-pr-deploys > /tmp/err.txt
      #     ERROR_CODE=$?
      #     ROLE_TIMEOUT_MSG="The AWS assume role session token is due to expire"
      #     if grep -q "$ROLE_TIMEOUT_MSG" /tmp/err.txt ; then
      #       echo "stderr for ansible has the error \"$ROLE_TIMEOUT_MSG\""
      #       echo "Re-assuming role and re-running step"
      #       echo "##vso[task.setvariable variable=has_aws_role_timedout;]true"

      #     elif [ $ERROR_CODE -ne 0 ] ; then 
      #       echo "ansible has unhandled error, re-raising"
      #       >&2 cat /tmp/err.txt
      #       exit -1
      #     fi
      #     cat /tmp/err.txt

      #   displayName: "cleanup older pr deploys"
