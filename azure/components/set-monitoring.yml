parameters:
  - name: set_status_monitoring
  - name: set_ping_monitoring
  - name: stage_name
  - name: apigee_environment
  - name: service_name
  - name: service_base_path


steps:
  - bash: |
      echo "Setting stage name as snake case for monitoring"
      export MONITORING_STAGE_NAME="${{ replace(parameters.stage_name, '_', '-') }}"
      echo "MONITORING_STAGE_NAME=${MONITORING_STAGE_NAME}"
      echo "##vso[task.setvariable variable=MONITORING_STAGE_NAME]$MONITORING_STAGE_NAME"
    displayName: 'Setting MONITORING_STAGE_NAME'

  - bash: |
      if [[ "${{ parameters.apigee_environment }}" == "prod" ]]; then
        export url="https://api.service.nhs.uk/monitoring-sd/service"
        export status_body='{ "${{ parameters.service_name }}": { "${{ parameters.apigee_environment }}": [ "${{ parameters.service_name }}@$(MONITORING_STAGE_NAME)=http_2xx https://api.service.nhs.uk/${{ parameters.service_base_path }}/_status" ] } }'
        export ping_body='{ "${{ parameters.service_name }}": { "${{ parameters.apigee_environment }}": [ "${{ parameters.service_name }}@$(MONITORING_STAGE_NAME)=http_2xx https://api.service.nhs.uk/${{ parameters.service_base_path }}/_ping" ] } }'

        echo "##vso[task.setvariable variable=url]$url"
        echo "##vso[task.setvariable variable=status_body]$status_body"
        echo "##vso[task.setvariable variable=ping_body]$ping_body"
      else
        export url="https://internal-dev.api.service.nhs.uk/monitoring-sd/service"
        export status_body='{ "${{ parameters.service_name }}": { "${{ parameters.apigee_environment }}": [ "${{ parameters.service_name }}@$(MONITORING_STAGE_NAME)=http_2xx https://${{ parameters.apigee_environment }}.api.service.nhs.uk/${{ parameters.service_base_path }}/_status" ] } }'
        export ping_body='{ "${{ parameters.service_name }}": { "${{ parameters.apigee_environment }}": [ "${{ parameters.service_name }}@$(MONITORING_STAGE_NAME)=http_2xx https://${{ parameters.apigee_environment }}.api.service.nhs.uk/${{ parameters.service_base_path }}/_ping" ] } }'

        echo "##vso[task.setvariable variable=url]$url"
        echo "##vso[task.setvariable variable=status_body]$status_body"
        echo "##vso[task.setvariable variable=ping_body]$ping_body"

      fi
    displayName: Setting monitoring url and body

  - ${{ if parameters.set_status_monitoring }}:
    - bash: |
        curl --fail -X 'POST' -H 'apikey: $(MONITORING_API_KEY)' -d '$(status_body)' $(url)
      displayName: Enable _status monitoring

  - ${{ if not(parameters.set_status_monitoring) }}:
    - bash: |
        curl --fail -X 'DELETE' -H 'apikey: $(MONITORING_API_KEY)' -d '$(status_body)' $(url)
      displayName: Disable _status monitoring

  - ${{ if parameters.set_ping_monitoring }}:
    - bash: |
        curl --fail -X 'POST' -H 'apikey: $(MONITORING_API_KEY)' -d '$(ping_body)' $(url)
      displayName: Enable _ping monitoring

  - ${{ if not(parameters.set_ping_monitoring) }}:
    - bash: |
        curl --fail -X 'DELETE' -H 'apikey: $(MONITORING_API_KEY)' -d '$(ping_body)' $(url)
      displayName: Disable _ping monitoring
