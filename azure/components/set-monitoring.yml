parameters:
  - name: enable_status_monitoring
    default: false
  - name: enable_ping_monitoring
    default: false
  - name: stage_name
  - name: apigee_environment
  - name: service_name
  - name: service_base_path


steps:
  - bash: |
      echo "Setting stage name as snake case for monitoring"
      export MONITORING_STAGE_NAME="${{ replace(parameters.stage_name, '_', '-') }}"
      echo "MONITORING_STAGE_NAME=${MONITORING_STAGE_NAME}"
      echo "##vso[task.setvariable variable=MONITORING_STAGE_NAME]$MONITORING_STAGE_NAME"
    displayName: 'Setting MONITORING_STAGE_NAME'

  - bash: |
      if [[ "${{ parameters.apigee_environment }}" == "prod" ]]; then
        export url="https://api.service.nhs.uk/monitoring-sd/service"
        export body='{ "${{ parameters.service_name }}": { "${{ parameters.apigee_environment }}": [ "${{ parameters.service_name }}@$(MONITORING_STAGE_NAME)=http_2xx https://api.service.nhs.uk/${{ parameters.service_base_path }}" ] } }'
        echo "##vso[task.setvariable variable=url]$url"
        echo "##vso[task.setvariable variable=body]$body"
      else
        export url="https://internal-dev.api.service.nhs.uk/monitoring-sd/service"
        export body='{ "${{ parameters.service_name }}": { "${{ parameters.apigee_environment }}": [ "${{ parameters.service_name }}@$(MONITORING_STAGE_NAME)=http_2xx https://${{ parameters.apigee_environment }}.api.service.nhs.uk/${{ parameters.service_base_path }}" ] } }'
        echo "##vso[task.setvariable variable=url]$url"
        echo "##vso[task.setvariable variable=body]$body"
      fi
    displayName: Setting monitoring url and body

  - ${{ if parameters.enable_status_monitoring }}:
    - bash: |
        curl --fail -X 'POST' -H 'apikey: $(MONITORING_API_KEY)' -d '$(body)/_status' $(url)
      displayName: Enable _status monitoring

  - ${{ if not(parameters.enable_status_monitoring) }}:
    - bash: |
        curl --fail -X 'DELETE' -H 'apikey: $(MONITORING_API_KEY)' -d '$(body)/_status' $(url)
      displayName: Disable _status monitoring

  - ${{ if parameters.enable_ping_monitoring }}:
    - bash: |
        curl --fail -X 'POST' -H 'apikey: $(MONITORING_API_KEY)' -d '(body)/_ping' $(url)
      displayName: Enable _ping monitoring

  - ${{ if not(parameters.enable_ping_monitoring) }}:
    - bash: |
        curl --fail -X 'DELETE' -H 'apikey: $(MONITORING_API_KEY)' -d '$(body)/_ping' $(url)
      displayName: Disable _ping monitoring
