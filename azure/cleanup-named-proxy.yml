name: "$(SourceBranchName)+$(BuildID)"

trigger: none

pr: none

parameters:
  - name: service_name
    displayName: Name of service to be removed
    type: string
    default: ""

  - name: service_name_short
    displayName: Short name of service to be removed
    type: string
    default: ""

  - name: has_ecs_backend
    displayName: Target service has ecs backend
    type: boolean

  - name: environment
    displayName: Name of target environment
    type: string
    default: ""

stages:
  - ${{ if in(parameters.env, 'internal-qa', 'ref', 'internal-qa-sandbox', 'internal-dev-sandbox', 'internal-dev') }}:
      - template: ./components/cleanup-proxy-choose-approval.yml
        parameters:
          apigee_org: nonprod         
          aws_account: ptl
          aws_profile: apm_ptl
          service_name: ${{ service_name }}
          service_name_short: ${{ service_name_short }}
          has_ecs_backed: ${{ has_ecs_backend }}
          APIGEE_ENVIRONMENT: ${{ environment }}
          APIGEE_ACCESS_TOKEN: $(secret.AccessToken)

  - ${{ if in(parameters.env, 'dev', 'int', 'sandbox', 'prod') }}:
      - template: ./components/cleanup-proxy-choose-approval.yml
        parameters:
          apigee_org: prod
          aws_account: prod
          aws_profile: apm_prod
          service_name: ${{ service_name }}
          service_name_short: ${{ service_name_short }}
          has_ecs_backed: ${{ has_ecs_backend }}
          APIGEE_ENVIRONMENT: ${{ environment }}
          APIGEE_ACCESS_TOKEN: $(secret.AccessToken)