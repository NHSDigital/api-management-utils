parameters:
  - name: service_name
    type: string
  - name: apigee_environment
  - name: apigee_organization

steps:
- bash: 'sudo apt-get install npm curl jq -y'
  displayName: 'Setup curl and jq'

- bash: |
    git clone https://github.com/NHSDigital/api-management-utils.git $(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/utils
    cd $(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/utils
    git checkout APM-1315-build-steps
  displayName: Clone utils

- bash: "make install"
  workingDirectory: "$(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/utils"
  displayName: "Install utils pre-requisites"

  # TODO: Get friendly name step

- bash: |
    export SERVICE_NAME="${{ parameters.service_name }}"
    export APIGEE_ENVIRONMENT="${{ parameters.apigee_environment }}"
    export APIGEE_ORGANIZATION="${{ parameters.apigee_organization }}"
    export APIGEE_ACCESS_TOKEN="$(secret.AccessToken)"
    export SPEC_FILE="$(Pipeline.Workspace)/s/${{ parameters.service_name }}/*/${{ parameters.service_name }}.json

    poetry run ansible-playbook ansible/deploy-apigee-spec.yml
  workingDirectory: "$(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/utils"
  displayName: "Deploy Spec & Portal"
