parameters:
  - name: spec_file
    type: string
  - name: service_name
    type: string
  - name: apigee_environment
  - name: apigee_organization
  - name: fully_qualified_service_name
    type: string
  - name: friendly_api_name
    type: string
    default: ''
  - name: portal_api_requires_callback_url
    type: boolean
  - name: make_spec_visible
    type: boolean

steps:
- bash: |
    declare -A FRIENDLY_ENV_NAMES=( ["prod"]="(Production)" ["sandbox"]="(Sandbox)" ["int"]="(Integration Testing)" ["dev"]="(Development)" ["ref"]="(Reference)" ["internal-qa"]="(Internal QA)" ["internal-qa-sandbox"]="(Internal QA Sandbox)" ["internal-dev"]="(Internal Development)" ["internal-dev-sandbox"]="(Internal Development Sandbox)" )
    export FRIENDLY_ENV="${FRIENDLY_ENV_NAMES["${{ parameters.apigee_environment }}"]}"

    if [ -z "${{ parameters.friendly_api_name }}" ]; then
      export API_NAME="${{ parameters.fully_qualified_service_name }} ${FRIENDLY_ENV}"
    else
      export API_NAME="${{ parameters.friendly_api_name }} ${FRIENDLY_ENV}"
    fi

    echo "Setting friendly name of: $API_NAME"

    echo "##vso[task.setvariable variable=FRIENDLY_NAME]$API_NAME"
  displayName: "Set Portal API Friendly Name"

- bash: |
    export SERVICE_NAME="${{ parameters.fully_qualified_service_name }}"
    export APIGEE_ENVIRONMENT="${{ parameters.apigee_environment }}"
    export APIGEE_ORGANIZATION="nhsd-${{ parameters.apigee_organization }}"
    export APIGEE_ACCESS_TOKEN="$(secret.AccessToken)"
    export SPEC_FILE="$(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/${{ parameters.spec_file }}"
    export FRIENDLY_NAME="$(FRIENDLY_NAME)"
    export VISIBLE="${{ parameters.make_spec_visible }}"
    export REQUIRE_CALLBACK_URL="${{ parameters.portal_api_requires_callback_url }}"
    
    poetry run ansible-playbook ansible/deploy-apigee-spec.yml
  workingDirectory: "$(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/utils"
  displayName: "Deploy Spec & Portal"
