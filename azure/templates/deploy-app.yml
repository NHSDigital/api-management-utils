parameters:
  - name: service_name
    type: string
  - name: apigee_environment
  - name: apigee_organization
  - name: fully_qualified_service_name
    type: string
  - name: test_app_callback_url
    type: string
  - name: test_app_attributes
    type: object
  - name: functional_test_steps
    type: stepList
  - name: non_functional_test_steps
    type: stepList

steps:
  - bash: |
      if [ -z "${{ parameters.test_app_callback_url }}" ]; then
        export CALLBACK_URL="https://nhsd-apim-testing-${{ parameters.apigee_environment }}.herokuapp.com/callback"
      else
        export CALLBACK_URL="${{ parameters.test_app_callback_url }}"
      fi

      echo "##vso[task.setvariable variable=CALLBACK_URL]$CALLBACK_URL"
    displayName: Set callback URL

  - ${{ if parameters.functional_test_steps }}:
    - bash: |
        set -euo pipefail

        export SERVICE_NAME="${{ parameters.fully_qualified_service_name }}"
        export APIGEE_ENVIRONMENT="${{ parameters.apigee_environment }}"
        export APIGEE_ORGANIZATION="nhsd-${{ parameters.apigee_organization }}"
        export APIGEE_ACCESS_TOKEN="$(secret.AccessToken)"
        export API_PRODUCT="internal-testing-${{ parameters.apigee_environment }}"
        export VAR_PATH="$(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/utils"

        poetry run ansible-playbook ansible/deploy-apigee-app.yml
      workingDirectory: "$(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/utils"
      displayName: "Deploy test app for functional testing"

  - ${{ if parameters.functional_test_steps }}:
    - template: ../components/set-app-attributes.yml
      parameters:
        test_app_attributes: ${{ parameters.test_app_attributes }}

  - ${{ if parameters.functional_test_steps }}:
    - template: ../components/set-app-credentials.yml
      parameters:
        service_name: ${{ parameters.service_name }}

  - ${{ each functional_test_step in parameters.functional_test_steps }}:
    - ${{ functional_test_step }}

  - ${{ if parameters.non_functional_test_steps }}:
    - bash: |
        set -euo pipefail

        export SERVICE_NAME="${{ parameters.fully_qualified_service_name }}"
        export APIGEE_ENVIRONMENT="${{ parameters.apigee_environment }}"
        export APIGEE_ORGANIZATION="nhsd-${{ parameters.apigee_organization }}"
        export APIGEE_ACCESS_TOKEN="$(secret.AccessToken)"
        export API_PRODUCT="${{ parameters.fully_qualified_service_name }}"
        export VAR_PATH="$(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/utils"

        poetry run ansible-playbook ansible/deploy-apigee-app.yml
      workingDirectory: "$(Pipeline.Workspace)/s/${{ parameters.service_name }}/$(SERVICE_ARTIFACT_NAME)/utils"
      displayName: "Deploy test app for non-functional testing"
  
  - ${{ if parameters.non_functional_test_steps }}:
    - template: ../components/set-app-attributes.yml
      parameters:
        test_app_attributes: ${{ parameters.test_app_attributes }}
  
  - ${{ if parameters.non_functional_test_steps }}:
    - template: ../components/set-app-credentials.yml
      parameters:
        service_name: ${{ parameters.service_name }}
  
  - ${{ each functional_test_step in parameters.non_functional_test_steps }}:
    - ${{ functional_test_step }}
