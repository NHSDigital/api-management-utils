
parameters:
  - name: 'utils_dir'
    type: string
    default: 'utils'

steps:

  - task: Cache@2
    displayName: "Cache Utils python Dependencies"
    inputs:
      key:  nhsd-utils-pyenv | $(Agent.OS) | ${{ parameters.utils_dir }}/poetry.lock
      path: "${{ parameters.utils_dir }}/.venv"
      restoreKeys: |
        nhsd-utils-pyenv | $(Agent.OS) | ${{ parameters.utils_dir }}/poetry.lock
        nhsd-utils-pyenv | $(Agent.OS)

  - bash: |
      if ! hash pip3 2>/dev/null; then
        sudo apt-get -yq install python3-pip
      fi
      if ! dpkg -l | grep python3-venv > /dev/null; then
        sudo apt-get -yq install python3-venv
      fi
      pip3 install --upgrade pip setuptools
      if ! python --version | grep 'Python 3' > /dev/null; then
        sudo unlink /usr/bin/python
        sudo ln -s /usr/bin/python3 /usr/bin/python
      fi
      if [ -f $HOME/.poetry/env ]; then
        source $HOME/.poetry/env
      fi
      if ! hash poetry 2>/dev/null; then
        curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python3
      fi
      make --no-print-directory -C ${{ parameters.utils_dir }} install
    displayName: "Install Utils dependencies"



